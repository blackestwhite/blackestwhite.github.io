<!doctype html><html><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>درباره defer در گو
| بلاگ مهدی اکبری
</title><link rel=stylesheet href=https://blackestwhite.github.io/style.css><meta name=google-site-verification content="CfxD9VHCwx4FDNI2vnUTd7GHbY_8uASYNw5Vi_9G3FU"></head><body class="container mx-auto fa"><header><div class="my-4 border-b"><div class=flex><div><img src="https://avatars1.githubusercontent.com/u/33098161?s=460&u=29871eef7376c5612bb255f1ba1aae1d14b8583b&v=4" class="w-24 h-24 rounded-full"></div><div class="flex items-center"><div class=mr-2><h1 class=font-bold>مهدی اکبری</h1><h2>توسعه دهنده</h2></div></div></div><nav class="flex mt-4"><a href=/fa class="m-3 text-sky-500">خانه</a>
<a href=/fa/posts class="m-3 text-sky-500">لیست نوشته ها</a>
<a href=/posts/>نوشته‌های انگلیسی</a></nav></div></header><main class=p-2><h1 class="mt-8 mb-2 text-xl font-bold border-slate-300 p-3 border-r-4">درباره defer در گو</h1><p class=mb-8><span class="inline-block text-sm text-slate-500">2023-06-11</span></p><p>قبل از هرچیز، بیایید ببینیم defer به طور خلاصه چی هست؟<br>دیفر میاد زمان فراخوانی شدن عبارت جلوی خودش رو به قبل جایی که تابع دربرگیرندش چیزی برگردونه موکول میکنه.<br><br>یعنی چی؟ این کد رو ببنید.<br><br><br><br></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Hey I&#39;m defered.&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Hello World.&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><br>ما اگر اینو اجرا کنیم، خروجی زیر رو میده:<br><br><br><br></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>Hello World.
</span></span><span style=display:flex><span>Hey I&#39;m defered.
</span></span></code></pre></div><p><br>مشاهده کردید که اول سلام دنیا پرینت شد و بعد متن دیفر شده.<br><br><br>خب حالا که کاربرد خیلی ساده و نحوه کارکردش رو دیدید. یه سری نکات هست که باید بدونیم.<br><br><br><br></p><h2 id=۱-ارزیابی-آرگومان-ها>۱. ارزیابی آرگومان ها</h2><p>اسم آرگومان رو اوردم مجبورم تفاوت آرگومان با پارامتر رو بگم، پارامتر متغییری هستش که جزوی از امضای تابع/متود ما هستش اما آرگومان عباراتی هستن که ما موقع استفاده از تابع/متود بهش میدیم.<br><br><br><br></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Foo</span>(<span style=color:#a6e22e>a</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>b</span> <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Do something
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>anInt</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Foo</span>(<span style=color:#a6e22e>anInt</span>, <span style=color:#ae81ff>5</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><br>برای مثال در اینجا <code>a</code> و <code>b</code> پارامتر محسوب میشن و <code>anInt</code> و <code>5</code> آرگومان محسوب میشن.<br><br>حالا می‌دونیم آرگومان چیه. آرگومان هایی که به تابع دیفر شده، داده میشن. دقیقا همون زمانی که به خود defer می‌رسه ارزیابی میشه. نه وقتی که تابع جلوش فراخوانی میشه.<br><br><br><br></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>i</span>)
</span></span><span style=display:flex><span> <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><br>با اینکه <code>fmt.Println(i)</code> اخرین چیزیه که اجرا میشه. اما همچنان 0 پرینت میشه.<br><br>چطوری درستش کنیم؟<br>کافیه که آرگومان هارو ببریم داخل بدنه تابع دیفر شده.<br><br><br><br></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>i</span>)
</span></span><span style=display:flex><span> }()
</span></span><span style=display:flex><span> <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><br>اینجوری 1 پرینت میشه.<br><br><br><br></p><h2 id=۲-ارزیابی-متودها>۲. ارزیابی متودها</h2><p>اون پستی که من دیدم راجب دیفر گو، اومده بود نوشته بود: <strong>Evaluating Receiver Functions</strong> در واقع درست تر هست که بهشون بگیم توابع دریافت کننده اما چون احتمالا با مفهوم شی گرایی آشنا هستید و هستیم، از تشابه اومدن استفاده کردن و با این اسم <strong>متود</strong> پیش می‌ریم، گفتم توابع دریافت کننده بنظرم اسم بهتریه از اونجا که گو بر پایه زبان شی‌گرایی محسوب نمیشه و وقتی هم که میاییم این توابع رو تعریف کنیم بجای اینکه توی پارامتر تایپ رو بهش بدیم، قبل از تعریف اسم تابع نوع متغییر رو بهش می‌دیم.<br><br><br><br></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Person</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span> <span style=color:#a6e22e>Name</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#a6e22e>Person</span>) <span style=color:#a6e22e>SayHi</span>() {
</span></span><span style=display:flex><span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Hi, my name is&#34;</span>, <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Name</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span> <span style=color:#a6e22e>writer</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Person</span>{<span style=color:#a6e22e>Name</span>: <span style=color:#e6db74>&#34;Jhon&#34;</span>}
</span></span><span style=display:flex><span> <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>writer</span>.<span style=color:#a6e22e>SayHi</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#75715e>// change the name
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>writer</span>.<span style=color:#a6e22e>Name</span> = <span style=color:#e6db74>&#34;Sam&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><br>الان <code>SayHi</code> تابع دریافت کننده‌ست چرا که تایپ <code>Person</code> رو با نام <code>p</code> دریافت کرده.<br>به بیان دیگه SayHi متودی روی هر متغییری هست که تایپش Person باشه.<br><br><br>حالا. اینجا هم مثل قسمت ۱ میبینیم که خروجی به جای اینکه اسم جدید تحویل بده همون اسم قبلی یعنی جان رو تحویل میده.<br><br><br>مقدار <code>writer</code> در زمانی مورد ارزیابی قرار می‌گیره که ما میرسیم به استیتمنت <code>defer</code> و ازونجایی که متود <code>SayHi</code> یک دریافت کننده مقدار هستش(پوینتر دریافت نکرده برای <code>Person</code>)، بنابرین میاد یه کپی از <code>writer</code> می‌گیره و وقتی تابع خواست خارج بشه یا چیزی برگردونه متود <code>SayHi</code> روشو فراخوانی می‌کنه.<br><br><br>از اونجاییم که کپی از رایتر گرفته بود بنابرین تغییری که ما روی رایتر انجام میدیم روی رایتری که دست <code>defer</code> هست اعمال نمیشه.<br><br><br>اینم فیکس شدنیه؟<br>بله، کافیه از پوینتر روی تابع SayHiمون استفاده کنیم. اینجوری تغییری که صورت می‌گیره موقع فراخوانی <code>SayHi</code> اسم جدید رو پرینت می‌کنه. <em>منظورم از فراخوانی همون call کردن هستش.</em><br><br><br>متود اپدیت شده اینطوری میشه:<br><br><br><br></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Person</span>) <span style=color:#a6e22e>SayHi</span>() {
</span></span><span style=display:flex><span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Hi, my name is&#34;</span>, <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Name</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><br><br></p><h2 id=۳-نگران-panic-نباشید-defer-همچنان-فراخوانی-میشه>۳. نگران panic نباشید، defer همچنان فراخوانی میشه</h2><p>دیفر اجرا میشه حتی اگر تابع panic کنه. این قابلیت وقتی مفید واقع میشه که مثلا می‌خوایم فایل رو ببندیم یا تسک هارو کلین آپ کنیم یا پایگاه داده رو ببندیم یا قفل mutex رو باز کنیم.<br><br><br>برای اینکه از پایین رفتن سرویس جلوگیری کنیم معمولا میایم از ترکیب defer و recover استفاده می‌کنیم که بتونیم وضعیت های استثنایی که انتظارشو نداریم هندل کنیم.<br><br><br><br></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>r</span> <span style=color:#f92672>:=</span> recover(); <span style=color:#a6e22e>r</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Recovered from panic:&#34;</span>, <span style=color:#a6e22e>r</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    panic(<span style=color:#e6db74>&#34;This is a panic!&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Recovered from panic: This is a panic!
</span></span></span></code></pre></div><p><br>این دلیلی هستش که بسیاری از کتابخونه‌های مربوط به وب سرور (مثلا Gin) یه میان‌افزار(middleware) مربوط به recover کردن دارن که از همین تکنیک استفاده می‌کنه.<br><br><br><br></p><h2 id=۴-دیفر-میتونه-خروجی-تابع-رو-عوض-کنه>۴. دیفر می‌تونه خروجی تابع رو عوض کنه</h2><p>اگر از مقادیر بازگشتی نام‌گذاری شده(named return values) استفاده کنید، مثل مثال زیر:<br><br><br><br></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>deferMe</span>() (<span style=color:#a6e22e>x</span> <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>x</span> = <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><br>با حقه defer می‌تونید خروجی یه تابع رو قبل اینکه return کنه، تغییر بدید، به صورت زیر:<br><br><br><br></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>deferMe</span>()) <span style=color:#75715e>// 2
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>deferMe</span>() (<span style=color:#a6e22e>x</span> <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>() { <span style=color:#a6e22e>x</span> <span style=color:#f92672>*=</span> <span style=color:#ae81ff>2</span> }()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>x</span> = <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><br>یادتون باشه که استفاده از این روش باعث میشه خوندن/فهمیدن/دیباگ کردن کدتون کمی سخت تر بشه، فقط وقتی ضروری هستش از این روش استفاده کنید.<br><br><br><br></p><h2 id=۵-ترتیب-defer---اخری-داخل-اولی-بیرون>۵. ترتیب defer - اخری داخل، اولی بیرون</h2><p>منظورمون از اخری داخل، اولی بیرون چیه؟ LIFO = Last in First out<br>یعنی آخرین چیزی که وارد شده، اولین چیزیه که خارج میشه. ساختمان داده رو که یادتون هست؟<br>دیفر میاد عباراتی که باید اجرا بشن رو میریزه توی یه پشته(stack).<br><br><br>بیایید با مثال ببینید که متوجه شید:<br><br><br><br></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Third&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Second&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;First&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Hello World.&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><br>و اگر خروجی رو مشاهده کنیم، می‌بینیم:<br><br><br><br></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>Hello World.
</span></span><span style=display:flex><span>First
</span></span><span style=display:flex><span>Second
</span></span><span style=display:flex><span>Third
</span></span></code></pre></div><p><br><br></p><p>امیدوارم سلامت و تندرست باشید و از این مطلب لذت برده باشید، بدرود.<br><br><br><br></p><blockquote><p>اگر از این پست لذت بردید می‌تونید دوره‌ی ساخت پلتفرم آگهی خودروی من با زبان گو رو روی یوتوب ببینید:<br><a href="https://www.youtube.com/watch?v=HWGkbiE2xwM&list=PLEdTiWAAnicDqFc2p-zTLKyL44N9USvv9&pp=gAQBiAQB">لینک مربوطه</a></p></blockquote></main><footer><div class=h-36></div><div class=h-36></div><div class="border-t py-4 flex justify-center flex-wrap fixed w-full bottom-0 bg-white right-0 left-0"><a href=https://www.youtube.com/@blackestwhite class=m-3>youtube</a>
<a href=http://t.me/blackestwhite class=m-3>telegram</a>
<a href=https://twitter.com/byblackestwhite class=m-3>twitter</a>
<a href=https://github.com/blackestwhite class=m-3>github</a></div></footer></body></html>