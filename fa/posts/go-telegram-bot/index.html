<!doctype html><html><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>محیط توسعه و دیپلوی من برای ربات تلگرام با گو
| بلاگ مهدی اکبری
</title><link rel=stylesheet href=https://blackestwhite.github.io/style.css><meta name=google-site-verification content="CfxD9VHCwx4FDNI2vnUTd7GHbY_8uASYNw5Vi_9G3FU"></head><body class="container mx-auto fa"><header><div class="my-4 border-b"><div class=flex><div><img src="https://avatars1.githubusercontent.com/u/33098161?s=460&u=29871eef7376c5612bb255f1ba1aae1d14b8583b&v=4" class="w-24 h-24 rounded-full"></div><div class="flex items-center"><div class=mr-2><h1 class=font-bold>مهدی اکبری</h1><h2>توسعه دهنده</h2></div></div></div><nav class="flex mt-4"><a href=/fa class="m-3 text-sky-500">خانه</a>
<a href=/fa/posts class="m-3 text-sky-500">لیست نوشته ها</a>
<a href=/posts/>نوشته‌های انگلیسی</a></nav></div></header><main class=p-2><h1 class="mt-8 mb-2 text-xl font-bold border-slate-300 p-3 border-r-4">محیط توسعه و دیپلوی من برای ربات تلگرام با گو</h1><p class=mb-8><span class="inline-block text-sm text-slate-500">2023-02-01</span></p><p>اول فوریه هستش من قصد داشتم از سال میلادی جدید (۲۰۲۳) بیشتر بنویسم ولی همین اولش خورد تو ذوقم سر بی نظمی هام و عدم درس خوندن در طول ترم و خواب و برنامه و زندگیم همه بهم ریخت ولی خب جون سالم به در بردم.<br><br><br>خب قبل از هرچیزی بگم استک من:</p><p>۱- git<br>۲- github<br>۳- bash<br>۴- Go (Golang)<br>۵- MongoDB<br>۶- Docker (با docker compose)<br>۷- Redis (اگر ریت لیمیت و کش نیاز بود)<br><br><br><br><br>برای ربات از پکیج <code>https://github.com/tucnak/telebot</code> استفاده می‌کنم.<br>نمونه ساده استفاده‌ش:<br><br><br><br></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;os&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>tele</span> <span style=color:#e6db74>&#34;gopkg.in/telebot.v3&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>pref</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>tele</span>.<span style=color:#a6e22e>Settings</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Token</span>:  <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Getenv</span>(<span style=color:#e6db74>&#34;TOKEN&#34;</span>),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Poller</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>tele</span>.<span style=color:#a6e22e>LongPoller</span>{<span style=color:#a6e22e>Timeout</span>: <span style=color:#ae81ff>10</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>},
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>tele</span>.<span style=color:#a6e22e>NewBot</span>(<span style=color:#a6e22e>pref</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>Handle</span>(<span style=color:#e6db74>&#34;/hello&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>c</span> <span style=color:#a6e22e>tele</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Send</span>(<span style=color:#e6db74>&#34;Hello!&#34;</span>)
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>Start</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><br><br><br>حالا ازونجایی که تو ایران تلگرام فیلتره باید روی سیستمی که داریم توسعه میدیم قابلیت پروکسی رو اد کنیم و روی کلاینت HTTP ربات اضافه کنیم.<br><br>برای مثال من که از v2ray استفاده می‌کنم طوری کلاینتمو تنظیم کردم که روی پورت ۱۰۸۰۸ یه ساکس فایو باز کنه. پس توی کانفیگ کلاینت رباتم میگم که روی لوکال هاست پورت ۱۰۸۰۸ وصل شه و فقط این در صورتی اجرا میشه که من انتهای دستور اجرا یه کلمه local هم اضافه کنم. (چون داخل دیپلوی سرورمون نیاز به این نداریم)<br><br><br><br></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;os&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>tele</span> <span style=color:#e6db74>&#34;gopkg.in/telebot.v3&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>transport</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Transport</span>{}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>) &gt; <span style=color:#ae81ff>1</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;local&#34;</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>proxyUrl</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>&#34;localhost:10808&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>dialer</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>proxy</span>.<span style=color:#a6e22e>SOCKS5</span>(<span style=color:#e6db74>&#34;tcp&#34;</span>, <span style=color:#a6e22e>proxyUrl</span>, <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>proxy</span>.<span style=color:#a6e22e>Direct</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>transport</span>.<span style=color:#a6e22e>DialContext</span> = <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>network</span>, <span style=color:#a6e22e>address</span> <span style=color:#66d9ef>string</span>) (<span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>Conn</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>dialer</span>.<span style=color:#a6e22e>Dial</span>(<span style=color:#a6e22e>network</span>, <span style=color:#a6e22e>address</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cl</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Client</span>{<span style=color:#a6e22e>Transport</span>: <span style=color:#a6e22e>transport</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>pref</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>tele</span>.<span style=color:#a6e22e>Settings</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Token</span>:  <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>TG_BOT_TOKEN</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Poller</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>tele</span>.<span style=color:#a6e22e>LongPoller</span>{<span style=color:#a6e22e>Timeout</span>: <span style=color:#ae81ff>10</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>},
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Client</span>: <span style=color:#a6e22e>cl</span>,
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>tele</span>.<span style=color:#a6e22e>NewBot</span>(<span style=color:#a6e22e>pref</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>Handle</span>(<span style=color:#e6db74>&#34;/hello&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>c</span> <span style=color:#a6e22e>tele</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Send</span>(<span style=color:#e6db74>&#34;Hello!&#34;</span>)
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>Start</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><br><br><br>فایل <code>dockerfile</code> رو اینجوری مینویسم<br><br><br><br></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> golang:1.19.0-alpine3.16 as builder</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> go.* ./<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> go mod download<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> . .<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> go build -o /app/app .<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> alpine:3.13.1</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apk add --no-cache tzdata<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> TZ<span style=color:#f92672>=</span>Asia/Tehran<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> .env .<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>builder /app/app .<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [<span style=color:#e6db74>&#34;/app/app&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p><br><br><br>فایل <code>docker-compose.yml</code> رو اینجوری مینویسم<br><br><br><br></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#39;3&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>: 
</span></span><span style=display:flex><span>  <span style=color:#f92672>mongodb</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>mongo</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>/vol/project-name/data/mongo-bot-backend:/data/db</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>app</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>build</span>: <span style=color:#ae81ff>.</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>depends_on</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>mongodb</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>links</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>mongodb</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
</span></span></code></pre></div><p><br><br><br>خب حالا که همه اینا امادست پوش میکنیم به گیتهاب عزیز.<br>حالا یه حرکت ریز که کلی زمان واستون سیو میکنه اینه که بیاید یه اسکریپت بنویسید که توی سرورتون هر ۱۰ ثانیه git pull رو اجرا کنه.<br>بعدش یه git hooks براش تعریف میکنید که بعد از مرج شدن یه دستوری اجرا بشه.<br><br>ما قراره این puller رو تو فایل <code>puller.sh</code> بسازیم.<br><br><br><br></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> true; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    git pull &amp;&gt; /dev/null
</span></span><span style=display:flex><span>    sleep <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span>
</span></span></code></pre></div><p><br><br><br>حالا نکته اساسی اینه، داخل سرورتون ریپازیتوری رو کلون کنید برید داخلش و فایل <code>post-merge</code> رو داخل hooks های ریپازیتوریتون ایجاد کنید.<br>مسیرش اینطوری میشه:<br><br><br><br></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>
</span></span><span style=display:flex><span>.git/hooks/post-merge
</span></span></code></pre></div><p><br><br><br>و محتویاتش باید این باشه:<br><br><br><br></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#!/bin/bash</span>
</span></span><span style=display:flex><span>docker compose down
</span></span><span style=display:flex><span>docker compose up -d --build
</span></span></code></pre></div><p><br><br><br>کاری که این اسکریپت میکنه، این هستش که کانتینر های قبلی رو میاره پایین و جدیدا رو بیلد میگیره و میاره بالا.<br><br>یادتون نره پرمیشن اجرا بدین به اسکریپت ها به وسیله دستور chmod +x با اسم فایل<br><br>حالا همه چی امادست فقط کافیه دستورای زیر اجرا کنید که پولر ران شه<br><br><br><br></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>
</span></span><span style=display:flex><span>./puller.sh &amp;
</span></span><span style=display:flex><span><span style=color:#75715e># بهتون یه پروسس آیدی میده که باید بدید به دستور زیر، عدد رو بدید به دیس اون</span>
</span></span><span style=display:flex><span>disown pid
</span></span></code></pre></div><p><br><br><br>حالا میتونید از سرور برید بیرون و از این به بعد هرچی به برنچ اصلیتون پوش کنید اتومات پول میشه بعدش گیت هوکز ران میشه و کانتینر هاتون رو میاره پایین، سپس دوباره بیلد میگیره و میاره بالا.<br><br>در طی نوشتن این پست فهمیدم، همچین چیزایی رو اگه ویدیو بگیرم بهتره تا اینکه بنویسم&mldr; به هر حال موفق باشید.</p></main><footer><div class=h-36></div><div class=h-36></div><div class="border-t py-4 flex justify-center flex-wrap fixed w-full bottom-0 bg-white right-0 left-0"><a href=https://www.youtube.com/@blackestwhite class=m-3>youtube</a>
<a href=http://t.me/blackestwhite class=m-3>telegram</a>
<a href=https://twitter.com/byblackestwhite class=m-3>twitter</a>
<a href=https://github.com/blackestwhite class=m-3>github</a></div></footer></body></html>