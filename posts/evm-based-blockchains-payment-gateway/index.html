<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>EVM-Based Blockchains Payment Gateway
| Mahdi Akbari's Blog</title><link rel=stylesheet href=https://blackestwhite.github.io/style.css><meta name=google-site-verification content="CfxD9VHCwx4FDNI2vnUTd7GHbY_8uASYNw5Vi_9G3FU"></head><body class="container mx-auto en"><header><div class="my-4 border-b"><div class=flex><div><img src="https://avatars1.githubusercontent.com/u/33098161?s=460&u=29871eef7376c5612bb255f1ba1aae1d14b8583b&v=4" class="w-24 h-24 rounded-full"></div><div class="flex items-center"><div class=ml-2><h1 class=font-bold>Mahdi Akbari</h1><h2>Developer</h2></div></div></div><nav class="flex mt-4"><a href=/ class="m-3 text-sky-500">Home</a>
<a href=/posts class="m-3 text-sky-500">List of posts</a></nav></div></header><main class=p-2><h1 class="mt-8 mb-2 text-xl font-bold border-slate-300 p-3 border-l-4">EVM-Based Blockchains Payment Gateway</h1><p class=mb-8><span class="inline-block text-sm text-slate-500">2023-08-24</span></p><p>In this post we are going to understand how a basic payment gateway in Ethereum Virtual Machine based blockchain would work.<br><br><br>As you migh know the main langauge to write an Ethereum smart contract is Solidity so we&rsquo;re gonna use Solidity.<br><br><br><img src=/posts/images/off-chain.svg alt="off-chain signing"><br><br><br>note that the payment should be stored in database off-chain, otherwise we cannot track what happened to the transaction.<br><br><br>now let&rsquo;s dive in what happens on-chain, how should we control the flow.<br><br></p><h3 id=an-overview>an overview:</h3><ol><li>define an address who is the owner of the contract</li><li>know the public key which signs the data.</li><li>check if the payment ID is paid or not.</li><li>check if the payment is still valid (expiration)</li><li>have a mechanism to validate the signature of the payment</li><li>be able to pause the smart contract if any attacks or problems had occured</li></ol><br>now let's dive into coding part.<br><br><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-solidity data-lang=solidity><span style=display:flex><span><span style=color:#66d9ef>pragma solidity</span> <span style=color:#f92672>^</span><span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>8</span>.<span style=color:#ae81ff>18</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>contract</span> <span style=color:#a6e22e>Invoice</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>address</span> <span style=color:#66d9ef>public</span> owner;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>address</span> <span style=color:#66d9ef>public</span> signer;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>bool</span> <span style=color:#66d9ef>public</span> functioning;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>mapping</span>(<span style=color:#66d9ef>bytes32</span> <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>bool</span>) <span style=color:#66d9ef>public</span> isPaid;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>event</span> <span style=color:#a6e22e>PaymentAccepted</span>(<span style=color:#66d9ef>bytes32</span> <span style=color:#66d9ef>indexed</span> hash, <span style=color:#66d9ef>uint</span> time, <span style=color:#66d9ef>uint</span> value);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// settin owner, signer and functioning(being able to pause the contract) on construction
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>constructor</span>(<span style=color:#66d9ef>address</span> _signer) {
</span></span><span style=display:flex><span>        owner <span style=color:#f92672>=</span> msg.sender;
</span></span><span style=display:flex><span>        functioning <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>        signer <span style=color:#f92672>=</span> _signer;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// modifier to restrict access on contract methods
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>modifier</span> <span style=color:#a6e22e>onlyAdmin</span>() {
</span></span><span style=display:flex><span>        require(msg.sender <span style=color:#f92672>==</span> owner, <span style=color:#e6db74>&#34;only admin can do this&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>_</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// modifier to only let the method work if the contract is functioning
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>modifier</span> <span style=color:#a6e22e>onlyFunctioning</span> {
</span></span><span style=display:flex><span>        require(functioning <span style=color:#f92672>==</span> <span style=color:#66d9ef>true</span>, <span style=color:#e6db74>&#34;contract is not functioning right now&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>_</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// being able to set the signer again by the owner of the contract
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>setSigner</span>(<span style=color:#66d9ef>address</span> _signer) <span style=color:#66d9ef>public</span> onlyAdmin {
</span></span><span style=display:flex><span>        signer <span style=color:#f92672>=</span> _signer;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// being able to set the owner again
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>setOwner</span>(<span style=color:#66d9ef>address</span> _owner) <span style=color:#66d9ef>public</span>  onlyAdmin {
</span></span><span style=display:flex><span>        owner <span style=color:#f92672>=</span> _owner;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><br>this is the basic functionality that we needed for restricting and keeping contract safe.<br>now we should add a method to pay and another to validate the payment.<br><br><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-solidity data-lang=solidity><span style=display:flex><span><span style=color:#66d9ef>pragma solidity</span> <span style=color:#f92672>^</span><span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>8</span>.<span style=color:#ae81ff>18</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>contract</span> <span style=color:#a6e22e>Invoice</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// rest of the code we wrote above
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>pay</span>(
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>bytes12</span> ID,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>uint</span> expiration,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>bytes32</span> providedHash,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>address</span> receiver,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>uint8</span> _v,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>bytes32</span> _r,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>bytes32</span> _s
</span></span><span style=display:flex><span>    ) <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>payable</span> onlyFunctioning {
</span></span><span style=display:flex><span>        require(validatePayment(ID, msg.value, expiration, receiver, providedHash, _v, _r, _s), <span style=color:#e6db74>&#34;payment not valid&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>payable</span>(receiver).transfer(msg.value);
</span></span><span style=display:flex><span>        isPaid[providedHash] <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>        emit PaymentAccepted(providedHash, block.timestamp, msg.value);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>validatePayment</span>(
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>bytes12</span> ID,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>uint</span> value,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>uint</span> expiration,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>address</span> receiver,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>bytes32</span> providedHash,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>uint8</span> _v,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>bytes32</span> _r,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>bytes32</span> _s,
</span></span><span style=display:flex><span>    ) <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>view</span> <span style=color:#66d9ef>returns</span>(<span style=color:#66d9ef>bool</span> valid) {
</span></span><span style=display:flex><span>        require(isPaid[providedHash] <span style=color:#f92672>==</span> <span style=color:#66d9ef>false</span>, <span style=color:#e6db74>&#34;already been paid&#34;</span>);
</span></span><span style=display:flex><span>        require(block.timestamp <span style=color:#f92672>&lt;=</span> expiration, <span style=color:#e6db74>&#34;payment is expired&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>bytes</span> <span style=color:#66d9ef>memory</span> prefix <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\x19</span><span style=color:#e6db74>Ethereum Signed Message:</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>32&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// order is important and should be the same in off-chain app
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>bytes32</span> ourHash <span style=color:#f92672>=</span> keccak256(abi.encodePacked(ID, value, receiver, expiration));
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>bytes32</span> payloadHash <span style=color:#f92672>=</span> keccak256(abi.encodePacked(prefix, ourHash));
</span></span><span style=display:flex><span>        require(ourHash <span style=color:#f92672>==</span> providedHash, <span style=color:#e6db74>&#34;hash mismatch&#34;</span>);
</span></span><span style=display:flex><span>        require(ecrecover(payloadHash, _v, _r, _s) <span style=color:#f92672>==</span> signer, <span style=color:#e6db74>&#34;signature mismatch&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><br>and this is the very simple implentation of a simple payment gateway.<br>for the simplicity sake I didn't implemented the code for ERC-20 integration but it's possible too.<br><br><h2 id=engage-and-connect>Engage and Connect</h2><p>Wish you enjoyed reading this post in. If you’re interested in collaboration, you can find me on GitHub at <a href=https://github.com/blackestwhite>GitHub Profile</a>. I also maintain a blog in Persian at <a href=https://blackestwhite.github.io/fa>blackestwhite.github.io/fa</a>. Feel free to get in touch with me via email at <a href=mailto:pesaregoal@gmail.com>pesaregoal@gmail.com</a>. I’m always open to new opportunities and discussions.</p></main><footer><div class=h-36></div><div class=h-36></div><div class="border-t py-4 flex justify-center flex-wrap fixed w-full bottom-0 bg-white right-0 left-0"><a href=https://www.youtube.com/@blackestwhite class=m-3>youtube</a>
<a href=http://t.me/meNevise class=m-3>telegram</a>
<a href=https://twitter.com/byblackestwhite class=m-3>twitter</a>
<a href=https://github.com/blackestwhite class=m-3>github</a></div></footer></body></html>